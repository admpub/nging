(function(){var factory=function(exports){var pluginName="image-dialog";exports.fn.imageDialog=function(){var _this=this;var cm=this.cm;var lang=this.lang;var editor=this.editor;var settings=this.settings;var cursor=cm.getCursor();var selection=cm.getSelection();var imageLang=lang.dialog.image;var classPrefix=this.classPrefix;var iframeName=classPrefix+"image-iframe";var dialogName=classPrefix+pluginName,dialog;cm.focus();var loading=function(e){var a=dialog.find("."+classPrefix+"dialog-mask");a[e?"show":"hide"]()};if(editor.find("."+dialogName).length<1){var guid=(new Date).getTime();var action=settings.imageUploadURL+(settings.imageUploadURL.indexOf("?")>=0?"&":"?")+"guid="+guid;if(settings.crossDomainUpload){action+="&callback="+settings.uploadCallbackURL+"&dialog_id=editormd-image-dialog-"+guid}var dialogContent=(settings.imageUpload?'<form action="'+action+'" target="'+iframeName+'" method="post" enctype="multipart/form-data" class="'+classPrefix+'form">':'<div class="'+classPrefix+'form">')+(settings.imageUpload?'<iframe name="'+iframeName+'" id="'+iframeName+'" guid="'+guid+'"></iframe>':"")+"<label>"+imageLang.url+"</label>"+'<input type="text" data-url />'+function(){return settings.imageUpload?'<div class="'+classPrefix+'file-input">'+'<input type="file" name="'+classPrefix+'image-file" accept="image/*" />'+'<input type="submit" value="'+imageLang.uploadButton+'" />'+"</div>":""}()+(settings.imageBrowseFn?'<div class="'+classPrefix+'file-browse">'+'<input type="button" class="'+classPrefix+'btn" value="'+imageLang.browseButton+'" />'+"</div>":"")+"<br/>"+"<label>"+imageLang.alt+"</label>"+'<input type="text" value="'+selection+'" data-alt />'+"<br/>"+"<label>"+imageLang.link+"</label>"+'<input type="text" value="http://" data-link />'+"<br/>"+(settings.imageUpload?"</form>":"</div>");dialog=this.createDialog({title:imageLang.title,width:settings.imageUpload?465:380,height:254,name:dialogName,content:dialogContent,mask:settings.dialogShowMask,drag:settings.dialogDraggable,lockScreen:settings.dialogLockScreen,maskStyle:{opacity:settings.dialogMaskOpacity,backgroundColor:settings.dialogMaskBgColor},buttons:{enter:[lang.buttons.enter,function(){var e=this.find("[data-url]").val();var a=this.find("[data-alt]").val();var i=this.find("[data-link]").val();if(e===""){alert(imageLang.imageURLEmpty);return false}var t=a!==""?' "'+a+'"':"";if(i===""||i==="http://"){cm.replaceSelection("!["+a+"]("+e+t+")")}else{cm.replaceSelection("[!["+a+"]("+e+t+")]("+i+t+")")}if(a===""){cm.setCursor(cursor.line,cursor.ch+2)}this.hide().lockScreen(false).hideMask();return false}],cancel:[lang.buttons.cancel,function(){this.hide().lockScreen(false).hideMask();return false}]}});dialog.attr("id",classPrefix+"image-dialog-"+guid);if(settings.imageBrowseFn){var fileBrowse=dialog.find("."+classPrefix+"file-browse ."+classPrefix+"btn");fileBrowse.bind("click",function(){settings.imageBrowseFn.call(this,{editormd:_this,dialog:dialog})})}if(!settings.imageUpload){return}var fileInput=dialog.find('[name="'+classPrefix+'image-file"]');fileInput.bind("change",function(){var fileName=fileInput.val();var isImage=new RegExp("(\\.("+settings.imageFormats.join("|")+"))$","i");if(fileName===""){alert(imageLang.uploadFileEmpty);return false}if(!isImage.test(fileName)){alert(imageLang.formatNotAllowed+settings.imageFormats.join(", "));return false}loading(true);var submitHandler=function(){var uploadIframe=document.getElementById(iframeName);uploadIframe.onload=function(){loading(false);var body=(uploadIframe.contentWindow?uploadIframe.contentWindow:uploadIframe.contentDocument).document.body;var json=body.innerText?body.innerText:body.textContent?body.textContent:null;json=typeof JSON.parse!=="undefined"?JSON.parse(json):eval("("+json+")");if(!json)return false;if(json.success===1){dialog.find("[data-url]").val(json.url)}else{alert(json.message)}return false}};dialog.find('[type="submit"]').bind("click",submitHandler).trigger("click")})}dialog=editor.find("."+dialogName);dialog.find('[type="text"]').val("");dialog.find('[type="file"]').val("");dialog.find("[data-link]").val("http://");this.dialogShowMask(dialog);this.dialogLockScreen();dialog.show()}};if(typeof require==="function"&&typeof exports==="object"&&typeof module==="object"){module.exports=factory}else if(typeof define==="function"){if(define.amd){define(["editormd"],function(e){factory(e)})}else{define(function(e){var a=e("./../../editormd");factory(a)})}}else{factory(window.editormd)}})();